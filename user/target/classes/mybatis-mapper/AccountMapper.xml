<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--namespace 非常重要：必须是 Mapper 类的全路径-->
<mapper namespace="demo.mapper.AccountMapper">
    <resultMap id="account" type="demo.bean.Account" >
        <result column="id" property="id" />
        <result column="username" property="username" />
        <result column="password" property="password" />
        <result column="phone" property="phone" />
    </resultMap>
    <!-- 用户查询结果的列 -->
    <sql id="base_columns">
        u.id AS id, u.username AS username, u.password AS password
    </sql>
    <!-- 用户登陆的验证 -->
    <select id="loadByName" resultMap="accountWithRole">
        SELECT
        <include refid="base_columns"></include>,
        r.id AS r_id, r.name AS r_name
        FROM USER AS u
        LEFT JOIN user_role AS ur ON u.id = ur.user_id
        LEFT JOIN role AS r ON ur.role_id = r.id
        WHERE u.username = #{name}
    </select>

    <resultMap id="accountWithRole" type="demo.bean.Account">
        <result column="id" property="id" />
        <result column="name" property="username" />
        <result column="password" property="password" />
        <result column="phone" property="phone" />
        <collection property="authorities" ofType="demo.bean.Role" columnPrefix="r_">
            <result column="id" property="id"/>
            <result column="name" property="authority"/>
        </collection>
    </resultMap>

</mapper>
